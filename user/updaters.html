<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Updaters &mdash; GerryChain  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Good Data Practices" href="data.html" />
    <link rel="prev" title="Working with Partitions" href="partitions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #0099cd" >
            <a href="../index.html" class="icon icon-home"> GerryChain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Overview of the Chain</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting started with GerryChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="recom.html">Running a chain with ReCom</a></li>
<li class="toctree-l1"><a class="reference internal" href="partitions.html">Working with Partitions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Updaters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#useful-updater-functions-in-gerrychain">Useful updater functions in GerryChain</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-your-own-updater-function">Writing your own updater function</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Good Data Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="geometries.html">Working With Geometries</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimizers.html">Optimization Methods of GerryChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="geometric_optimizers.html">Advanced Example: Optimizing Using Geographic Quantities</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../topics/reproducibility.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/tools.html">Evaluating districting plans in the real world</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/contributing.html">Contributing to GerryChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/reporting.html">Reporting Issues</a></li>
</ul>
<p class="caption"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../full_ref.html">Full Package Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #0099cd" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GerryChain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Updaters</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user/updaters.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="updaters">
<h1>Updaters<a class="headerlink" href="#updaters" title="Permalink to this headline">¶</a></h1>
<p>Depending on the questions you are investigating, there are many different
values you might want to compute for each partition in your Markov chain. If you
are interested in compactness, you might want to compute the area and perimeter
of each part of the partition so that you can compute compactness scores. If you
are interested in partisan lean, you might want to compute hypothetical election
results using the districts defined by the partition.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Partition</span></code> class allows you to define custom properties for the partitions
in your Markov chain. You can do this by providing a dictionary of updater
functions when you first create a partition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gerrychain</span> <span class="kn">import</span> <span class="n">Partition</span><span class="p">,</span> <span class="n">Graph</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
<span class="n">assignment</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">my_updater</span><span class="p">(</span><span class="n">partition</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;Hello!&quot;</span>

<span class="n">partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">assignment</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;my_custom_property&quot;</span><span class="p">:</span> <span class="n">my_updater</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s2">&quot;my_custom_property&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>This will output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Hello!</span>
</pre></div>
</div>
<p>Recall from <a class="reference external" href="./partitions.html">the Partitions section</a> that we can also
access this property using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">partition</span><span class="o">.</span><span class="n">my_custom_property</span>
</pre></div>
</div>
<p>Which also outputs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&#39;Hello!&#39;</span>
</pre></div>
</div>
<p>This partition and all subsequent partitions in the chain will have this
<code class="docutils literal notranslate"><span class="pre">my_custom_property</span></code> attribute. If we flip a node in <code class="docutils literal notranslate"><span class="pre">partition</span></code> to create a new
partition, we can still access this property:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">partition</span><span class="o">.</span><span class="n">flip</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Are the partitions different? {new_partition is not partition}&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_partition</span><span class="p">[</span><span class="s2">&quot;my_custom_property&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>This outputs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Are the partitions different? True</span>
<span class="go">Hello!</span>
</pre></div>
</div>
<div class="section" id="useful-updater-functions-in-gerrychain">
<h2>Useful updater functions in GerryChain<a class="headerlink" href="#useful-updater-functions-in-gerrychain" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">gerrychain.updaters</span></code> submodule provides some updaters for common tasks like
aggregating data and computing the cut edges of a partition:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Tally</span></code>: Aggregates a node attribute (e.g. population) over each part of the
partition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cut_edges</span></code>: Returns the set of cut edges (edges whose nodes are in
different parts of the partition) of the partition. This is required for
most of the proposal functions in <code class="docutils literal notranslate"><span class="pre">gerrychain.proposals</span></code>.</p></li>
</ul>
<p>Here is an example using both of these updaters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gerrychain.updaters</span> <span class="kn">import</span> <span class="n">cut_edges</span><span class="p">,</span> <span class="n">Tally</span>
<span class="c1"># We&#39;ll use a 2x2 grid graph:</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span>
<span class="c1"># Give each of the nodes population 100:</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;population&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Partition the grid into two halves:</span>
<span class="n">assignment</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">cut_edges</span><span class="p">,</span>
        <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;population&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population by district:</span><span class="se">\n\t</span><span class="si">{partition[&#39;population&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cut edges in partition:</span><span class="se">\n\t</span><span class="si">{partition[&#39;cut_edges&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This outputs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Population by district:</span>
<span class="go">    {0: 200, 1: 200}</span>
<span class="go">Cut edges in partition:</span>
<span class="go">    {(1, 2), (0, 3)}</span>
</pre></div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">cut_edges</span></code> updater returns a set of edges, each represented as a tuple of
two nodes. Our <code class="docutils literal notranslate"><span class="pre">population</span></code> updater returns a dictionary mapping each part of
the partition to the total population in that part. Since we divided our grid in
half, we see parts <code class="docutils literal notranslate"><span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">1</span></code> both have population 200.</p>
<p>Now when we create a new partition by flipping a node of <code class="docutils literal notranslate"><span class="pre">partition</span></code>, we see the
values of the updaters change:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_partition</span> <span class="o">=</span> <span class="n">partition</span><span class="o">.</span><span class="n">flip</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population by district:</span><span class="se">\n\t</span><span class="si">{new_partition[&#39;population&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cut edges in partition:</span><span class="se">\n\t</span><span class="si">{new_partition[&#39;cut_edges&#39;]}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This outputs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Population by district:</span>
<span class="go">    {0: 100, 1: 300}</span>
<span class="go">Cut edges in partition:</span>
<span class="go">    {(0, 1), (1, 2)}</span>
</pre></div>
</div>
<p>As we should expect, flipping node <code class="docutils literal notranslate"><span class="pre">0</span></code> into part <code class="docutils literal notranslate"><span class="pre">1</span></code> increases the population of
part <code class="docutils literal notranslate"><span class="pre">1</span></code> to 300 and decreases the population of part <code class="docutils literal notranslate"><span class="pre">0</span></code> to 100. The cut edges
of the new partition are both of the edges incident to node <code class="docutils literal notranslate"><span class="pre">1</span></code>, since this is
the last remaining node in part <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div>
<div class="section" id="writing-your-own-updater-function">
<h2>Writing your own updater function<a class="headerlink" href="#writing-your-own-updater-function" title="Permalink to this headline">¶</a></h2>
<p>When using GerryChain to experiment with new metrics, proposals, or acceptance
rules, there usually comes a point when you need to implement a new updater. As
we saw in the first example, an updater is a function that takes the partition
as its argument and returns any type of value.</p>
<p>Let’s create an updater that returns the number of cut edges in the partition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">number_of_cut_edges</span><span class="p">(</span><span class="n">partition</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s2">&quot;cut_edges&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Note that this updater uses the value of the <code class="docutils literal notranslate"><span class="pre">cut_edges</span></code> updater in its
computation. This is completely allowed! All you need to do is make sure that
any updater that your updater depends on is included in the <code class="docutils literal notranslate"><span class="pre">updaters</span></code>
dictionary that we pass to <code class="docutils literal notranslate"><span class="pre">Partition</span></code>. We also need to make sure that we have
no cyclic dependencies: if the <code class="docutils literal notranslate"><span class="pre">cut_edges</span></code> updater also depended on
<code class="docutils literal notranslate"><span class="pre">number_of_cut_edges</span></code>, we would fall into an infinite loop when we called either
of them, resulting in a <code class="docutils literal notranslate"><span class="pre">RuntimeError:</span> <span class="pre">maximum</span> <span class="pre">recursion</span> <span class="pre">depth</span> <span class="pre">exceeded</span></code> error.</p>
</div>
<p>To try out our updater, we’ll use <a class="reference external" href="https://networkx.github.io">NetworkX</a> to
create a complete graph on 4 nodes, which we’ll partition in halves like the 2x2
grid. NetworkX is the graph library that GerryChain uses under the hood in its
<code class="docutils literal notranslate"><span class="pre">Graph</span></code> class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">networkx</span><span class="o">.</span><span class="n">complete_graph</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">assignment</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">cut_edges</span><span class="p">,</span>
    <span class="s2">&quot;number_of_cut_edges&quot;</span><span class="p">:</span> <span class="n">number_of_cut_edges</span>
<span class="p">}</span>
<span class="n">partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">assignment</span><span class="p">,</span> <span class="n">my_updaters</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can try out our custom <code class="docutils literal notranslate"><span class="pre">number_of_cut_edges</span></code> updater, and verify that its
value changes when the partition changes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s2">&quot;number_of_cut_edges&quot;</span><span class="p">])</span>
<span class="n">new_partition</span> <span class="o">=</span> <span class="n">partition</span><span class="o">.</span><span class="n">flip</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_partition</span><span class="p">[</span><span class="s2">&quot;number_of_cut_edges&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>This will output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">4</span>
<span class="go">3</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="partitions.html" class="btn btn-neutral float-left" title="Working with Partitions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="data.html" class="btn btn-neutral float-right" title="Good Data Practices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Metric Geometry and Gerrymandering Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>