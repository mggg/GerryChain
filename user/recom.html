<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running a chain with ReCom &mdash; GerryChain  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Working with Partitions" href="partitions.html" />
    <link rel="prev" title="Getting started with GerryChain" href="quickstart.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #0099cd" >
            <a href="../index.html" class="icon icon-home"> GerryChain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Overview of the Chain</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting started with GerryChain</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running a chain with ReCom</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#a-simple-recom-chain">A Simple Recom Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="#region-aware-recom">Region-Aware ReCom</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-the-region-aware-implementation-works">How the Region Aware Implementation Works</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#what-to-do-if-the-chain-gets-stuck">What to do if the Chain Gets Stuck</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-real-world-example">A Real-World Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-initial-districting-plan">Setting up the initial districting plan</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuring-our-updaters">Configuring our updaters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#instantiating-the-partition">Instantiating the partition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-markov-chain">Setting up the Markov chain</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#proposal">Proposal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constraints">Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-the-markov-chain">Configuring the Markov chain</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-chain">Running the chain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-plot">Create a plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="partitions.html">Working with Partitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="updaters.html">Updaters</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Good Data Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="geometries.html">Working With Geometries</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimizers.html">Optimization Methods of GerryChain</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../topics/reproducibility.html">Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/tools.html">Evaluating districting plans in the real world</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/contributing.html">Contributing to GerryChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topics/reporting.html">Reporting Issues</a></li>
</ul>
<p class="caption"><span class="caption-text">Index</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../full_ref.html">Full Package Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #0099cd" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GerryChain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Running a chain with ReCom</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user/recom.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="running-a-chain-with-recom">
<h1>Running a chain with ReCom<a class="headerlink" href="#running-a-chain-with-recom" title="Permalink to this headline">¶</a></h1>
<p>Our goal now is to get a handle on using GerryChain to run Markov chains with
both regular and region-aware settings. Throughout this guide, we’ll use the
toy state of GerryMandria, which has needs to be divided into 8 districts.</p>
<p>The legislature of the state of GerryMandria has provided us with the
following districting plan:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria.png"><img alt="../_images/gerrymandria.png" class="align-center" src="../_images/gerrymandria.png" style="width: 400px;" /></a>
<p>which has corresponding dual graph given by:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_district.png"><img alt="../_images/gerrymandria_district.png" class="align-center" src="../_images/gerrymandria_district.png" style="width: 400px;" /></a>
<p><code class="docutils literal notranslate"><span class="pre">gerrychain</span></code> works primarily with the dual graph of the districting plan, so
all of the pictures in this guide will use the dual graph as well.</p>
<div class="section" id="a-simple-recom-chain">
<h2>A Simple Recom Chain<a class="headerlink" href="#a-simple-recom-chain" title="Permalink to this headline">¶</a></h2>
<div class="center-container">
  <a href="https://github.com/mggg/GerryChain/tree/main/docs/_static/gerrymandria.json" class="download-badge" download>
    Download GerryMandria File
  </a>
</div>
<br style="line-height: 5px;"><p>Let us start by running a simple ReCom chain on this districting plan. Of course,
the first thing to do is to import the required packages:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">gerrychain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Partition</span><span class="p">,</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">MarkovChain</span><span class="p">,</span>
                        <span class="n">updaters</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gerrychain.proposals</span> <span class="kn">import</span> <span class="n">recom</span>
<span class="kn">from</span> <span class="nn">gerrychain.constraints</span> <span class="kn">import</span> <span class="n">contiguous</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># Set the random seed so that the results are reproducible!</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2024</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we set up the initial partition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="s2">&quot;./gerrymandria.json&quot;</span><span class="p">)</span>

<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">),</span>
    <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">cut_edges</span>
<span class="p">}</span>

<span class="n">initial_partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="o">=</span><span class="s2">&quot;district&quot;</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="n">my_updaters</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And we make the proposal:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This should be 8 since each district has 1 person in it.</span>
<span class="c1"># Note that the key &quot;population&quot; corresponds to the population updater</span>
<span class="c1"># that we defined above and not with the population column in the json file.</span>
<span class="n">ideal_population</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">)</span>

<span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can now set up the chain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">recom_chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">contiguous</span><span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">40</span>
<span class="p">)</span>
</pre></div>
</div>
<p>and run it with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">assignment_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recom_chain</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished step {i+1}/{len(recom_chain)}&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">assignment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll go ahead an collect the assignment at each step of the chain so
that we can watch the chain work in a fun animation (of course, it would be a
bad idea to do this for a chain with a large number of steps).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib_inline.backend_inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">mcm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">assignment_list</span><span class="p">)):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span> <span class="p">:(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
    <span class="n">node_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">assignment_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">node</span><span class="p">])</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>
    <span class="n">node_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">assignment_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">node</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">()}</span>

    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">node_colors</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">node_labels</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show_frame</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">frames</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

<span class="n">slider</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Frame:&#39;</span><span class="p">)</span>
<span class="n">slider</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;500px&#39;</span>
<span class="n">widgets</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">show_frame</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">slider</span><span class="p">)</span>
</pre></div>
</div>
<p>And this should generate a little widget that you can move through to see the chain
in action! Here is a gif of what it should look like:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_ensemble.gif"><img alt="../_images/gerrymandria_ensemble.gif" class="align-center" src="../_images/gerrymandria_ensemble.gif" style="width: 400px;" /></a>
</div>
<div class="section" id="region-aware-recom">
<h2>Region-Aware ReCom<a class="headerlink" href="#region-aware-recom" title="Permalink to this headline">¶</a></h2>
<p>Of course, in the state of GerryMandria, the legislature has decided that it would like
to try to keep the municipality of Gerryville together in a single district. In fact, it would
really prefer to keep all of the municipalities together if possible, and, as such any analysis
that you do needs to be on a ensemble of districting plans that try to keep municipalities
together. Here is a picture of the municipalities in GerryMandria:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_cities.png"><img alt="../_images/gerrymandria_cities.png" class="align-center" src="../_images/gerrymandria_cities.png" style="width: 400px;" /></a>
<p>Fortunately, <code class="docutils literal notranslate"><span class="pre">gerrychain</span></code> has a built-in functionality that allows for
region-aware ReCom chains which create ensembles
of districting plans that try to keep particular regions of interest together.
And it only takes one extra line of code: we simply update
our proposal to include a <code class="docutils literal notranslate"><span class="pre">region_surcharge</span></code> which increases the importance of the
edges within the municipalities.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>And this will produce the following ensemble:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_region_ensemble.gif"><img alt="../_images/gerrymandria_region_ensemble.gif" class="align-center" src="../_images/gerrymandria_region_ensemble.gif" style="width: 400px;" /></a>
<p>Now, the legislature of GerryMandria has decided that it would also like to try
to keep the counties together as well. They mention to you that it would be nice
to keep the municipalities together, but that it is more important to keep the
water districts together. Here is a picture of the water districts in GerryMandria:</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_water.png"><img alt="../_images/gerrymandria_water.png" class="align-center" src="../_images/gerrymandria_water.png" style="width: 400px;" /></a>
<p>Notice that there is a river that seems to cut through the middle of the state,
and so it is not going to be possible to keep all of the water districts together
and all of the municipalities together in one plan. However, we can try to keep
the water districts together as much as possible, and then, within those water
districts, try to be sensitive to the boundaries of the municipalities. Again,
this only requires for us to edit the <code class="docutils literal notranslate"><span class="pre">region_surcharge</span></code> parameter of the proposal</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Since we are trying to be sensitive to multiple bits of information, we should probably
also increase the length of our chain to make sure that we have time to mix properly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">recom_chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">contiguous</span><span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">10000</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Then, we can run the chain and look at the last 40 assignments in the ensemble</p>
<a class="reference internal image-reference" href="../_images/gerrymandria_water_muni_ensemble.gif"><img alt="../_images/gerrymandria_water_muni_ensemble.gif" class="align-center" src="../_images/gerrymandria_water_muni_ensemble.gif" style="width: 400px;" /></a>
<p>Comparing the last map with the municipality and water district maps, we can see
that the chain has done a pretty good job of keeping the water districts together
while also being sensitive to the municipalities</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../_images/gerrymandria_water_and_muni_aware.png"><img alt="../_images/gerrymandria_water_and_muni_aware.png" src="../_images/gerrymandria_water_and_muni_aware.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-text">The last map in the ensemble from the 10000 step region-aware ReCom chain with
surcharges of 0.2 for the municipalities and 0.8 for the water districts.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<div style="display: flex; justify-content: space-around;">
    <figure style="text-align: center;">
        <img src="../../_images/gerrymandria_cities.png" style="width: 100%;">
        <figcaption><em>Municipalities of Gerrymandria</em></figcaption>
    </figure>
    <figure style="text-align: center;">
        <img src="../../_images/gerrymandria_water.png" style="width: 100%;">
        <figcaption><em>Water Districts of GerryMandria</em><figcaption>
    </figure>
</div><div class="section" id="how-the-region-aware-implementation-works">
<h3>How the Region Aware Implementation Works<a class="headerlink" href="#how-the-region-aware-implementation-works" title="Permalink to this headline">¶</a></h3>
<p>When working with region-aware ReCom chains, it is worth knowing how the spanning tree
of the dual graph is being split. Weights from the interval <span class="math notranslate nohighlight">\([0,1]\)</span> are randomly
assigned to the edges of the graph and then the surcharges are applied to the edges in
the graph that span different regions specified by the <code class="docutils literal notranslate"><span class="pre">region_surcharge</span></code> dictionary.
So if we have <code class="docutils literal notranslate"><span class="pre">region_surcharge={&quot;muni&quot;:</span> <span class="pre">0.2,</span> <span class="pre">&quot;water&quot;:</span> <span class="pre">0.8}</span></code>, then the edges that
span different municipalities will be upweighted by 0.2 and the edges that span different
water districts will be upweighted by 0.8. We then draw a minimum spanning tree using
by greedily selecting the lowest-weight edges via Kruskal’s algorithm. The surcharges on
the edges helps ensure that the algorithm picks the edges interior to the region
before it picks the edges that bridge different regions.</p>
<p>This makes it very likely that each region is largely contained in a connected subtree
attached to a bridge node. Thus, when we make a cut, the regions attached to the
bridge node are more likely to be (mostly) preserved in the subtree on either side
of the cut.</p>
<p>In the implementation of <code class="xref py py-meth docutils literal notranslate"><span class="pre">biparition_tree()</span></code> we further bias this
choice by deterministically cutting bridge edges first (when possible). In the event that
multiple types of regions are specified, the surcharges are added together, and edges are
selected first by the number of types of regions that they span, and then by the
surcharge added to those weights. So, if we have a region surcharge dictionary of
<code class="docutils literal notranslate"><span class="pre">{&quot;a&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">4,</span> <span class="pre">&quot;c&quot;:</span> <span class="pre">2}</span></code> then we we look for edges according to the order</p>
<ul class="simple">
<li><p>(“a”, “b”, “c”)</p></li>
<li><p>(“b”, “c”)</p></li>
<li><p>(“a”, “b”)</p></li>
<li><p>(“a”, “c”)</p></li>
<li><p>(“b”)</p></li>
<li><p>(“c”)</p></li>
<li><p>(“a”)</p></li>
<li><p>random</p></li>
</ul>
<p>where the tuples indicate that a desired cut edge bridges both types of region in
the tuple. In the event that this is not the desired behaviour, then the user can simply
alter the <code class="docutils literal notranslate"><span class="pre">cut_choice</span></code> function in the constraints to be different. So, if the user
would prefer the cut edge to be a random edge with no deference to bridge edges,
then they might use <code class="docutils literal notranslate"><span class="pre">random.choice()</span></code> in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;water_dist&quot;</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="p">},</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">bipartition_tree</span><span class="p">,</span>
        <span class="n">cut_choice</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Note</strong>: When <code class="docutils literal notranslate"><span class="pre">region_surcharge</span></code> is not specified, <code class="docutils literal notranslate"><span class="pre">bipartition_tree</span></code> will behave as if
<code class="docutils literal notranslate"><span class="pre">cut_choice</span></code> is set to <code class="docutils literal notranslate"><span class="pre">random.choice</span></code>.</p>
</div>
</div>
<div class="section" id="what-to-do-if-the-chain-gets-stuck">
<h2>What to do if the Chain Gets Stuck<a class="headerlink" href="#what-to-do-if-the-chain-gets-stuck" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, either because of the constraints that you have imposed or because of
the shape of the graph that you are working with, a recom chain can get stuck and
will throw an error. For example, if we try to be a bit too demanding of the
region-aware chain given above
and ask for a plan that effectively never splits a municipality nor a water
district, then the chain will get stuck and throw an error. Here is the setup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gerrychain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Partition</span><span class="p">,</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">MarkovChain</span><span class="p">,</span>
                        <span class="n">updaters</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">accept</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gerrychain.proposals</span> <span class="kn">import</span> <span class="n">recom</span>
<span class="kn">from</span> <span class="nn">gerrychain.tree</span> <span class="kn">import</span> <span class="n">bipartition_tree</span>
<span class="kn">from</span> <span class="nn">gerrychain.constraints</span> <span class="kn">import</span> <span class="n">contiguous</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="s2">&quot;./gerrymandria.json&quot;</span><span class="p">)</span>

<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">),</span>
    <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">cut_edges</span>
<span class="p">}</span>

<span class="n">initial_partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="o">=</span><span class="s2">&quot;district&quot;</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="n">my_updaters</span>
<span class="p">)</span>

<span class="n">ideal_population</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">)</span>

<span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;water_dist&quot;</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="p">},</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">bipartition_tree</span><span class="p">,</span>
        <span class="n">max_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">recom_chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">contiguous</span><span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">assignment_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recom_chain</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished step {i + 1}/{len(recom_chain)}&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">assignment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
</pre></div>
</div>
<p>This will output the following sequence of warnings and errors</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">BipartitionWarning:</span>
<span class="go">Failed to find a balanced cut after 50 attempts.</span>
<span class="go">If possible, consider enabling pair reselection within your</span>
<span class="go">MarkovChain proposal method to allow the algorithm to select</span>
<span class="go">a different pair of nodes to try an recombine.</span>

<span class="go">RuntimeError: Could not find a possible cut after 100 attempts.</span>
</pre></div>
</div>
<p>Let’s break down what is happening in each of these:</p>
<ul>
  <li><strong>BipartitionWarning</strong>
    This is telling us that somewhere along the way,
    we picked a pair of districts that were difficult to bipartition underneath
    the constraints that we have imposed. More accurately, for the pair of districts
    that we have selected to recombine, we have selected a root node for a spanning
    tree, and we are trying to find a cut at some point along that tree that satisfies
    all of the conditions. We have tried to draw a tree 50 times and have failed to
    find a balanced cut of any of the trees starting from the selected root node.
    This indicates that either we have selected a difficult node to start from,
    or that the pair of districts we are considering is difficult
    to split regardless of the choice of root node.
    If the problem is the choice of root node, we can fix it by increasing the
    <code style="color: #E74C3C;">node_repeats</code> parameter of the
    <code style="color: #E74C3C;">MarkovChain</code>. However, if the problem is
    that the pair of districts themselves are difficult to split, then this can
    generally only be fixed by allowing the chain to reselect the pair of districts
    that it is trying to split.
  </li>
  <br style="line-height: 5px;">
  <li><strong>RuntimeError</strong>
      This is telling us that we have tried to draw a tree 10000 times for each
      node that we have selected, and that we failed to find a valid cut in all
      of them. This is a pretty strong indication that the pair of districts that
      we are trying to split is just too difficult to split and that we need to
      enable reselection.
  </li>
</ul><p>Okay, let’s see if we can fix this. First, we’ll try to increase the number of
node repeats:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="s2">&quot;./gerrymandria.json&quot;</span><span class="p">)</span>

<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">),</span>
    <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">cut_edges</span>
<span class="p">}</span>

<span class="n">initial_partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="o">=</span><span class="s2">&quot;district&quot;</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="n">my_updaters</span>
<span class="p">)</span>

<span class="n">ideal_population</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">)</span>

<span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>                <span class="c1"># &lt;-- This is the only change</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;water_dist&quot;</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="p">},</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">bipartition_tree</span><span class="p">,</span>
        <span class="n">max_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">recom_chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">contiguous</span><span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">assignment_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recom_chain</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished step {i + 1}/{len(recom_chain)}&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">assignment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this code, we can see that we get stuck once again, so this was not the fix.
Let’s try to enable reselection instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="s2">&quot;./gerrymandria.json&quot;</span><span class="p">)</span>

<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">),</span>
    <span class="s2">&quot;cut_edges&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">cut_edges</span>
<span class="p">}</span>

<span class="n">initial_partition</span> <span class="o">=</span> <span class="n">Partition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="o">=</span><span class="s2">&quot;district&quot;</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="n">my_updaters</span>
<span class="p">)</span>

<span class="n">ideal_population</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">)</span>

<span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOTPOP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">region_surcharge</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;muni&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="s2">&quot;water_dist&quot;</span><span class="p">:</span> <span class="mf">2.0</span>
    <span class="p">},</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">bipartition_tree</span><span class="p">,</span>
        <span class="n">max_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">allow_pair_reselection</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># &lt;-- This is the only change</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">recom_chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">contiguous</span><span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">assignment_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recom_chain</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished step {i + 1}/{len(recom_chain)}&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">assignment_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">assignment</span><span class="p">)</span>
</pre></div>
</div>
<p>And this time it works!</p>
</div>
<div class="section" id="a-real-world-example">
<h2>A Real-World Example<a class="headerlink" href="#a-real-world-example" title="Permalink to this headline">¶</a></h2>
<p>In this example, we’ll use GerryChain to analyze the 2011 districting plan for
Pennsylvania’s state legislative districts. We’ll compare the partisan vote
shares in the 2011 plan to those in an ensemble of districting plans generated
by our ReCom chain.</p>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<p>As always, the first step is to import everything we need</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">gerrychain</span> <span class="kn">import</span> <span class="p">(</span><span class="n">GeographicPartition</span><span class="p">,</span> <span class="n">Partition</span><span class="p">,</span> <span class="n">Graph</span><span class="p">,</span> <span class="n">MarkovChain</span><span class="p">,</span>
                        <span class="n">proposals</span><span class="p">,</span> <span class="n">updaters</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">accept</span><span class="p">,</span> <span class="n">Election</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gerrychain.proposals</span> <span class="kn">import</span> <span class="n">recom</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-initial-districting-plan">
<h3>Setting up the initial districting plan<a class="headerlink" href="#setting-up-the-initial-districting-plan" title="Permalink to this headline">¶</a></h3>
<div class="center-container">
  <a href="https://github.com/mggg/GerryChain/tree/main/docs/_static/PA_VTDs.json" class="download-badge" download>Download PA File</a>
</div>
<br style="line-height: 5px;"><p>We’ll create our graph using the example Pennsylvania json file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="s2">&quot;./PA_VTDs.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We may now configure <code class="xref py py-class docutils literal notranslate"><span class="pre">Election</span></code> objects representing some of
the election data from our file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">elections</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Election</span><span class="p">(</span><span class="s2">&quot;SEN10&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Democratic&quot;</span><span class="p">:</span> <span class="s2">&quot;SEN10D&quot;</span><span class="p">,</span> <span class="s2">&quot;Republican&quot;</span><span class="p">:</span> <span class="s2">&quot;SEN10R&quot;</span><span class="p">}),</span>
    <span class="n">Election</span><span class="p">(</span><span class="s2">&quot;SEN12&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Democratic&quot;</span><span class="p">:</span> <span class="s2">&quot;USS12D&quot;</span><span class="p">,</span> <span class="s2">&quot;Republican&quot;</span><span class="p">:</span> <span class="s2">&quot;USS12R&quot;</span><span class="p">}),</span>
    <span class="n">Election</span><span class="p">(</span><span class="s2">&quot;SEN16&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Democratic&quot;</span><span class="p">:</span> <span class="s2">&quot;T16SEND&quot;</span><span class="p">,</span> <span class="s2">&quot;Republican&quot;</span><span class="p">:</span> <span class="s2">&quot;T16SENR&quot;</span><span class="p">}),</span>
    <span class="n">Election</span><span class="p">(</span><span class="s2">&quot;PRES12&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Democratic&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES12D&quot;</span><span class="p">,</span> <span class="s2">&quot;Republican&quot;</span><span class="p">:</span> <span class="s2">&quot;PRES12R&quot;</span><span class="p">}),</span>
    <span class="n">Election</span><span class="p">(</span><span class="s2">&quot;PRES16&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Democratic&quot;</span><span class="p">:</span> <span class="s2">&quot;T16PRESD&quot;</span><span class="p">,</span> <span class="s2">&quot;Republican&quot;</span><span class="p">:</span> <span class="s2">&quot;T16PRESR&quot;</span><span class="p">})</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="section" id="configuring-our-updaters">
<h4>Configuring our updaters<a class="headerlink" href="#configuring-our-updaters" title="Permalink to this headline">¶</a></h4>
<p>We want to set up updaters for everything we want to compute for each plan in the ensemble.
In this case, we want to keep track of the population of each district and election info
for each of our previously defined elections.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Population updater, for computing how close to equality the district</span>
<span class="c1"># populations are. &quot;TOTPOP&quot; is the population column from our shapefile.</span>
<span class="n">my_updaters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="n">updaters</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="s2">&quot;TOT_POP&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;population&quot;</span><span class="p">)}</span>

<span class="c1"># Election updaters, for computing election results using the vote totals</span>
<span class="c1"># from our shapefile.</span>
<span class="n">election_updaters</span> <span class="o">=</span> <span class="p">{</span><span class="n">election</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">election</span> <span class="k">for</span> <span class="n">election</span> <span class="ow">in</span> <span class="n">elections</span><span class="p">}</span>
<span class="n">my_updaters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">election_updaters</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="instantiating-the-partition">
<h4>Instantiating the partition<a class="headerlink" href="#instantiating-the-partition" title="Permalink to this headline">¶</a></h4>
<p>We can now instantiate the initial state of our Markov chain, using the 2011 districting plan</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">initial_partition</span> <span class="o">=</span> <span class="n">GeographicPartition</span><span class="p">(</span>
    <span class="n">graph</span><span class="p">,</span>
    <span class="n">assignment</span><span class="o">=</span><span class="s2">&quot;2011_PLA_1&quot;</span><span class="p">,</span>
    <span class="n">updaters</span><span class="o">=</span><span class="n">my_updaters</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The class <code class="xref py py-class docutils literal notranslate"><span class="pre">GeographicPartition</span></code> comes with built-in <code class="docutils literal notranslate"><span class="pre">area</span></code> and
<code class="docutils literal notranslate"><span class="pre">perimeter</span></code> updaters. We do not use them here since (i) the *.json file that we
are working with does not have geometric information and (ii) geometric updaters tend
to slow the chain quite considerably (and this is just an example), but they would
allow us to compute compactness scores like Polsby-Popper that depend on these
measurements.</p>
</div>
</div>
<div class="section" id="setting-up-the-markov-chain">
<h3>Setting up the Markov chain<a class="headerlink" href="#setting-up-the-markov-chain" title="Permalink to this headline">¶</a></h3>
<div class="section" id="proposal">
<h4>Proposal<a class="headerlink" href="#proposal" title="Permalink to this headline">¶</a></h4>
<p>First we’ll set up the ReCom proposal. To do this we will need to make use of the python
<a class="reference external" href="https://docs.python.org/3/library/functools.html">functools</a> package, specifically the <code class="docutils literal notranslate"><span class="pre">partial</span></code> function within this package.</p>
<div class="note admonition">
<p class="admonition-title">Use of <code class="docutils literal notranslate"><span class="pre">functools.partial</span></code></p>
<p>For the
uninitiated, the <code class="docutils literal notranslate"><span class="pre">functools.partial</span></code> function allows us to create a new function from
an existing function by binding the values of some of the arguments. For example,
we might have a function to make a colored square:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="k">def</span> <span class="nf">make_color_square</span><span class="p">(</span><span class="n">red_val</span><span class="p">,</span> <span class="n">green_val</span><span class="p">,</span> <span class="n">blue_val</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">red_val</span><span class="p">,</span> <span class="n">green_val</span><span class="p">,</span> <span class="n">blue_val</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">img</span>
</pre></div>
</div>
<p>And we can then use this to make a new function that always makes a blue square:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">make_blue_square</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">make_color_square</span><span class="p">,</span> <span class="n">red_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">green_val</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">make_color_square</span><span class="p">(</span><span class="n">red_val</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">green_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blue_val</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># Makes a red square</span>
<span class="n">make_blue_square</span><span class="p">(</span><span class="n">blue_val</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># Makes a blue square</span>
</pre></div>
</div>
</div>
<p>Back to Recom, we need to fix some parameters using <cite>functools.partial</cite>
before we can use it as our proposal function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The ReCom proposal needs to know the ideal population for the districts so that</span>
<span class="c1"># we can improve speed by bailing early on unbalanced partitions.</span>

<span class="n">ideal_population</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">)</span>

<span class="c1"># We use functools.partial to bind the extra parameters (pop_col, pop_target, epsilon, node_repeats)</span>
<span class="c1"># of the recom proposal.</span>
<span class="n">proposal</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">recom</span><span class="p">,</span>
    <span class="n">pop_col</span><span class="o">=</span><span class="s2">&quot;TOT_POP&quot;</span><span class="p">,</span>
    <span class="n">pop_target</span><span class="o">=</span><span class="n">ideal_population</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">node_repeats</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="constraints">
<h4>Constraints<a class="headerlink" href="#constraints" title="Permalink to this headline">¶</a></h4>
<p>To keep districts about as compact as the original plan, we would like to
constrain the number of cut edges between all of the districts (this will
keep our districts from being too snake-like).
We can do this using the <code class="xref py py-class docutils literal notranslate"><span class="pre">UpperBound</span></code> constraint,
and, as a general heuristic, we’ll bound the number of cut edges by twice the
number of cut edges in the initial plan.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cut_edges_length</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;cut_edges&quot;</span><span class="p">])</span>

<span class="n">compactness_bound</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">UpperBound</span><span class="p">(</span>
  <span class="n">cut_edges_length</span><span class="p">,</span>
  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;cut_edges&quot;</span><span class="p">])</span>
<span class="p">)</span>

<span class="n">pop_constraint</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">within_percent_of_ideal_population</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
</pre></div>
</div>
<div class="note admonition">
<p class="admonition-title">Coding Note</p>
<p>We can simplify the calling of this compactness bound using lambda functions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">compactness_bound</span> <span class="o">=</span> <span class="n">constraints</span><span class="o">.</span><span class="n">UpperBound</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;cut_edges&quot;</span><span class="p">]),</span>
  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">initial_partition</span><span class="p">[</span><span class="s2">&quot;cut_edges&quot;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The use of lambda functions tends to be a more advanced coding technique, but
the benefit is that we do not need to define a new function for each constraint
that we want to use, and they can make the code more readable.</p>
</div>
</div>
<div class="section" id="configuring-the-markov-chain">
<h4>Configuring the Markov chain<a class="headerlink" href="#configuring-the-markov-chain" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">chain</span> <span class="o">=</span> <span class="n">MarkovChain</span><span class="p">(</span>
    <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span>
        <span class="n">pop_constraint</span><span class="p">,</span>
        <span class="n">compactness_bound</span>
    <span class="p">],</span>
    <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="o">.</span><span class="n">always_accept</span><span class="p">,</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="n">initial_partition</span><span class="p">,</span>
    <span class="n">total_steps</span><span class="o">=</span><span class="mi">1000</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="running-the-chain">
<h3>Running the chain<a class="headerlink" href="#running-the-chain" title="Permalink to this headline">¶</a></h3>
<p>Now we’ll run the chain, putting the sorted Democratic vote percentages directly
into a <code class="xref py py-mod docutils literal notranslate"><span class="pre">pandas</span></code> <code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code> for analysis and plotting. The <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>
will have a row for each state of the chain. The first column of the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> will
hold the lowest Democratic vote share among the districts in each partition in the chain, the
second column will hold the second-lowest Democratic vote shares, and so on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This might take a few minutes.</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="nb">sorted</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s2">&quot;SEN12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">percents</span><span class="p">(</span><span class="s2">&quot;Democratic&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">chain</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If you are wondering what the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop inside of the parentheses
is doing, please see the <a class="reference external" href="./quickstart.html#list-comprehension">this note</a>.
If you install the <code class="docutils literal notranslate"><span class="pre">tqdm</span></code> package, you can see a progress bar
as the chain runs by running this code instead</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="nb">sorted</span><span class="p">(</span><span class="n">partition</span><span class="p">[</span><span class="s2">&quot;SEN12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">percents</span><span class="p">(</span><span class="s2">&quot;Democratic&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">partition</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">with_progress_bar</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-plot">
<h3>Create a plot<a class="headerlink" href="#create-a-plot" title="Permalink to this headline">¶</a></h3>
<p>Now we’ll create a box plot to help visualize the data report.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Draw 50% line</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#cccccc&quot;</span><span class="p">)</span>

<span class="c1"># Draw boxplot</span>
<span class="n">data</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>

<span class="c1"># Draw initial plan&#39;s Democratic vote %s (.iloc[0] gives the first row)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ro&quot;</span><span class="p">)</span>

<span class="c1"># Annotate</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Comparing the 2011 plan to an ensemble&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Democratic vote % (Senate 2012)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sorted districts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/recom_plot.svg" src="../_images/recom_plot.svg" /><p>There you go! To build on this, here are some possible next steps:</p>
<ul class="simple">
<li><p>Add, remove, or tweak the constraints</p></li>
<li><p>Perform a similar analysis on a different districting plan for Pennsylvania</p></li>
<li><p>Perform a similar analysis on a different state</p></li>
<li><p>Compute partisan symmetry scores like Efficiency Gap or Mean-Median, and
create a histogram of the scores of the ensemble.</p></li>
<li><p>Perform the same analysis using a different election than the 2012 Senate election</p></li>
<li><p>Collect Democratic vote percentages for <em>all</em> the elections we set up, instead
of just the 2012 Senate election.</p></li>
</ul>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quickstart.html" class="btn btn-neutral float-left" title="Getting started with GerryChain" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="partitions.html" class="btn btn-neutral float-right" title="Working with Partitions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Metric Geometry and Gerrymandering Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>